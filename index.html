<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Osaka & Kyoto Trip+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@700&family=Yomogi:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-cream: #f2ece4; --card-cream: #fffefc; --dusty-rose: #cfa8a8; --dusty-rose-dark: #b58e8e; --text-brown: #5c4e4e; }
        body { font-family: 'Yomogi', 'Mali', sans-serif; font-weight: 700; background: #e8e0d5; color: var(--text-brown); margin: 0; display: flex; justify-content: center; }
        .marker-font { font-family: 'Mali', cursive; }
        .phone-container { width: 100%; max-width: 430px; background: var(--bg-cream); min-height: 100vh; position: relative; padding-bottom: 100px; }
        .card-base { background: var(--card-cream); border-radius: 12px; padding: 0.8rem; margin-bottom: 0.8rem; border: 1.5px solid #eaddd0; box-shadow: 2px 2px 0px rgba(207, 168, 168, 0.2); position: relative; }
        .btn-rose { background: var(--dusty-rose); color: white; padding: 0.3rem 0.7rem; border-radius: 8px; font-size: 0.75rem; box-shadow: 2px 2px 0px var(--dusty-rose-dark); }
        .img-box { width: 100%; height: 140px; border-radius: 8px; object-fit: cover; margin: 8px 0; background: #eee; }
        .nav-container { background: rgba(255, 254, 252, 0.95); border-top: 1.5px solid #eaddd0; }
        .nav-active { color: var(--dusty-rose); border-top: 3px solid var(--dusty-rose); }
        #edit-modal { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 20px; }
        .modal-body { background: var(--bg-cream); width: 100%; max-width: 380px; border-radius: 20px; padding: 1.5rem; border: 2px solid var(--dusty-rose); box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .input-group { margin-bottom: 0.8rem; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--dusty-rose); margin-bottom: 4px; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; background: white; border: 1.5px solid #eaddd0; border-radius: 8px; padding: 8px; font-size: 0.9rem; font-family: 'Yomogi'; outline: none; }
        .timeline-line { border-left: 2px dashed #dcb5b5; margin-left: 10px; padding-left: 20px; position: relative; }
        .timeline-dot { content: ''; position: absolute; left: -6px; top: 10px; width: 10px; height: 10px; background: #cfa8a8; border-radius: 50%; border: 2px solid white; }
        .sync-btn { font-size: 10px; opacity: 0.6; padding: 2px 8px; border-radius: 10px; border: 1px solid #cfa8a8; }
        .sync-btn:hover { opacity: 1; background: white; }
    </style>
</head>
<body>

<div class="phone-container">
    <header class="sticky top-0 z-50 bg-[#f2ece4]/90 backdrop-blur-md px-4 py-3 border-b border-dashed border-[#eaddd0]">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-lg marker-font text-[#5c4e4e]">Osaka & Kyoto</h1>
                <div class="flex items-center space-x-2 text-[11px] mt-1 bg-white/40 p-1 rounded-lg">
                    <span id="osaka-weather">ğŸŒ¸ OSA ...</span>
                    <span class="text-[#dcb5b5]">|</span>
                    <span id="kyoto-weather">ğŸ KYO ...</span>
                </div>
            </div>
            <div class="text-right">
                <div class="px-2 py-1 bg-white/60 rounded-lg border border-[#eaddd0]">
                    <span class="text-[9px]">1 JPY=</span>
                    <span id="rate-value" class="marker-font text-base text-[#cfa8a8]">0.204</span>
                    <span class="text-[9px]">TWD</span>
                </div>
                <div class="flex gap-1 mt-2 justify-end">
                    <button onclick="exportData()" class="sync-btn text-[#cfa8a8]">ğŸ“¤ åŒ¯å‡º</button>
                    <button onclick="importData()" class="sync-btn text-[#cfa8a8]">ğŸ“¥ åŒ¯å…¥</button>
                </div>
            </div>
        </div>
    </header>

    <main class="p-4" id="content-area"></main>

    <div id="edit-modal">
        <div class="modal-body">
            <h2 class="text-center text-lg mb-4 text-[#5c4e4e]">âœï¸ ç·¨è¼¯å…§å®¹</h2>
            <div id="modal-inputs"></div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal()" class="flex-1 py-2 bg-white border border-[#eaddd0] rounded-xl text-sm">å–æ¶ˆ</button>
                <button onclick="saveEdit()" class="flex-1 py-2 btn-rose rounded-xl text-sm">å„²å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <nav class="nav-container fixed bottom-0 w-full max-w-[430px] px-1 py-2 z-50 flex justify-around items-center pb-6">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center w-1/6" data-id="itinerary"><span>ğŸ“…</span><span class="text-[9px]">Trip</span></button>
        <button onclick="switchTab('attractions')" class="nav-btn flex flex-col items-center w-1/6" data-id="attractions"><span>â›©ï¸</span><span class="text-[9px]">æ™¯é»</span></button>
        <button onclick="switchTab('hotels')" class="nav-btn flex flex-col items-center w-1/6" data-id="hotels"><span>ğŸ¨</span><span class="text-[9px]">ä½å®¿</span></button>
        <button onclick="switchTab('restaurants')" class="nav-btn flex flex-col items-center w-1/6" data-id="restaurants"><span>ğŸœ</span><span class="text-[9px]">ç¾é£Ÿ</span></button>
        <button onclick="switchTab('transport')" class="nav-btn flex flex-col items-center w-1/6" data-id="transport"><span>ğŸšƒ</span><span class="text-[9px]">äº¤é€š</span></button>
        <button onclick="switchTab('others')" class="nav-btn flex flex-col items-center w-1/6" data-id="others"><span>ğŸ“</span><span class="text-[9px]">å‚™è¨»</span></button>
    </nav>
</div>

<script>
let currentTab = 'itinerary';
let selectedDate = '3/18';
let transportType = 'é£›æ©Ÿ';
let currentEditId = null;

// é è¨­æ•¸æ“š
const defaultStore = {
    itinerary: [
        { id: 1, date: '3/18', time: '18:50', loc: 'TPE (æ¡ƒåœ’æ©Ÿå ´)', note: '16:50 å ±åˆ° / MM028' },
        { id: 2, date: '3/18', time: '22:15', loc: 'KIX (é—œè¥¿æ©Ÿå ´)', note: 'æŠµé”' },
        { id: 3, date: '3/18', time: '23:00', loc: 'æ©Ÿå ´æ¥é€', note: 'INNNN' },
        { id: 4, date: '3/19', time: '07:44', loc: 'æ¢…ç”°è»Šç«™', note: '2é€±å‰è²·ç¥¨(é˜ªæ€¥)' },
        { id: 5, date: '3/19', time: '09:00', loc: 'æ¸…æ°´å¯º', note: 'éœ€è³¼ç¥¨ï¼Œåƒ…æ”¶ç¾é‡‘' },
        { id: 9, date: '3/20', time: '09:00', loc: 'å¤§é˜ªåŸå¤©å®ˆé–£', note: 'éœ€äº‹å…ˆè³¼ç¥¨ / å¾å¤§æ‰‹é–€é€²' },
        { id: 15, date: '3/22', time: '07:15', loc: 'KIX (é—œè¥¿æ©Ÿå ´)', note: '05:15 å ±åˆ° / MM023' }
    ],
    attractions: [{ id: 21, date: '3/19', name: 'æ¸…æ°´å¯º', img: '', time: '06:00-18:00', note: 'é–€ç¥¨ç¾é‡‘' }],
    hotels: [{ id: 31, date: '3/19', name: 'ç›¸éµFRESA INN å¤§é˜ªé›£æ³¢', img: '', time: 'Check-in', note: '' }],
    restaurants: [{ id: 41, date: '3/20', name: 'Tsuruya å£½å–œç‡’', img: '', time: '19:00', note: 'å·²é è¨‚' }],
    transport: [{ id: 51, type: 'é£›æ©Ÿ', name: 'MM028', time: '18:50', note: 'å»ç¨‹' }],
    others: []
};

// è®€å– LocalStorage
let store = JSON.parse(localStorage.getItem('ok_trip_v5')) || defaultStore;

const iconEdit = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>`;

// --- åŒæ­¥åŠŸèƒ½ ---
function exportData() {
    const dataStr = JSON.stringify(store);
    // ä½¿ç”¨ç°¡å–®çš„ prompt é¡¯ç¤ºï¼Œæ–¹ä¾¿æ‰‹æ©Ÿé•·æŒ‰è¤‡è£½
    const dummy = document.createElement("textarea");
    document.body.appendChild(dummy);
    dummy.value = dataStr;
    dummy.select();
    document.execCommand("copy");
    document.body.removeChild(dummy);
    alert("æ•¸æ“šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼è«‹åˆ°å¦ä¸€å°è£ç½®è²¼ä¸Šã€‚");
}

function importData() {
    const dataStr = prompt("è«‹è²¼å…¥å¾å¦ä¸€å°è£ç½®åŒ¯å‡ºçš„ä»£ç¢¼ (JSON)ï¼š");
    if (dataStr) {
        try {
            const parsed = JSON.parse(dataStr);
            if (parsed.itinerary) {
                store = parsed;
                localStorage.setItem('ok_trip_v5', JSON.stringify(store));
                render();
                alert("åŒ¯å…¥æˆåŠŸï¼");
            }
        } catch (e) {
            alert("ä»£ç¢¼æ ¼å¼éŒ¯èª¤ï¼ŒåŒ¯å…¥å¤±æ•—ã€‚");
        }
    }
}
// ----------------

async function updateWeather() {
    const coords = { osaka: { lat: 34.69, lon: 135.50 }, kyoto: { lat: 35.01, lon: 135.76 } };
    const getWeatherIcon = (code) => { if (code <= 1) return 'â˜€ï¸'; if (code <= 3) return 'â˜ï¸'; if (code <= 67) return 'ğŸŒ§ï¸'; return 'â„ï¸'; };
    try {
        for (const city of ['osaka', 'kyoto']) {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords[city].lat}&longitude=${coords[city].lon}&current_weather=true`);
            const data = await res.json();
            const temp = Math.round(data.current_weather.temperature);
            const icon = getWeatherIcon(data.current_weather.weathercode);
            document.getElementById(`${city}-weather`).innerText = `${city === 'osaka' ? 'ğŸŒ¸ OSA' : 'ğŸ KYO'} ${icon} ${temp}Â°`;
        }
    } catch (e) { console.error("å¤©æ°£ç²å–å¤±æ•—", e); }
}

function render() {
    const area = document.getElementById('content-area');
    let html = '';
    const actionBtns = (tab, item) => `
        <div class="absolute top-2 right-2 flex items-center space-x-3 z-10">
            <button onclick="openModal('${tab}', ${item.id})" class="text-[#887a7a] hover:text-[#cfa8a8]">${iconEdit}</button>
            <button onclick="deleteItem('${tab}', ${item.id})" class="text-xs opacity-20 hover:opacity-100">âœ•</button>
        </div>`;

    if (currentTab === 'itinerary') {
        const days = ['3/18', '3/19', '3/20', '3/21', '3/22'];
        const dayNames = { '3/18': 'ç¬¬ä¸€å¤©', '3/19': 'ç¬¬äºŒå¤©', '3/20': 'ç¬¬ä¸‰å¤©', '3/21': 'ç¬¬å››å¤©', '3/22': 'ç¬¬äº”å¤©' };
        html = `<div class="flex justify-between items-center mb-6"><h2 class="text-xl marker-font">5D4N Overview</h2><button onclick="addItem()" class="btn-rose">+ åŠ è¡Œç¨‹</button></div>`;
        days.forEach(date => {
            const dayItems = store.itinerary.filter(i => i.date === date).sort((a,b) => a.time.localeCompare(b.time));
            html += `
                <div class="mb-8">
                    <div class="flex items-center mb-4">
                        <span class="bg-[#cfa8a8] text-white px-3 py-1 rounded-full text-xs marker-font mr-3">${dayNames[date]}</span>
                        <span class="text-sm font-bold text-[#887a7a]">${date}</span>
                        <div class="flex-grow border-t border-dashed border-[#cfa8a8] ml-4 opacity-30"></div>
                    </div>
                    <div class="timeline-line">
                        ${dayItems.length ? dayItems.map(i => `
                            <div class="card-base relative mb-4">
                                <div class="timeline-dot"></div>
                                ${actionBtns('itinerary', i)}
                                <div class="flex items-start">
                                    <div class="w-16 marker-font text-[#cfa8a8] text-xs pt-0.5">${i.time}</div>
                                    <div class="flex-1">
                                        <div class="text-[13px] font-bold">ğŸ“ ${i.loc}</div>
                                        ${i.note ? `<div class="text-[10px] text-gray-400 mt-1">${i.note}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<div class="text-[11px] text-gray-400 italic ml-2">æœ¬æ—¥ç„¡å®‰æ’</div>'}
                    </div>
                </div>
            `;
        });
    } else if (['attractions', 'hotels', 'restaurants'].includes(currentTab)) {
        html = `<div class="flex justify-between items-center mb-4">
            <select onchange="selectedDate=this.value;render()" class="bg-white border rounded px-2 py-1 text-xs outline-none">
                ${['3/18','3/19','3/20','3/21','3/22'].map(d=>`<option value="${d}" ${selectedDate===d?'selected':''}>${d}</option>`).join('')}
            </select>
            <button onclick="addItem()" class="btn-rose">+ æ–°å¢</button>
        </div>`;
        const list = store[currentTab].filter(item => item.date === selectedDate);
        list.forEach(item => {
            html += `<div class="card-base">${actionBtns(currentTab, item)}
                <h3 class="text-sm font-bold text-gray-800 pr-12">${item.name}</h3>
                <img src="${item.img || 'https://placehold.co/400x200?text=No+Image'}" class="img-box">
                <div class="text-[10px] space-y-1">
                    <p><span class="text-[#cfa8a8]">ğŸ•’ï¼š</span>${item.time}</p>
                    <p class="text-gray-500 mt-1 border-t border-dashed pt-1">${item.note || ''}</p>
                </div>
            </div>`;
        });
    } else if (currentTab === 'transport') {
        const types = ['é£›æ©Ÿ', 'ç«è»Š', 'æ±½è»Š', 'åœ°éµ'];
        html = `<div class="flex gap-2 mb-4 overflow-x-auto pb-1">` + 
               types.map(t => `<button onclick="transportType='${t}';render()" class="whitespace-nowrap px-4 py-1.5 rounded-full text-[11px] ${transportType===t?'bg-[#cfa8a8] text-white':'bg-white text-gray-400 border border-gray-100'}">${t}</button>`).join('') + 
               `</div>`;
        html += `<button onclick="addItem()" class="w-full btn-rose mb-4">+ æ–°å¢${transportType}ç´€éŒ„</button>`;
        const list = store.transport.filter(t => t.type === transportType);
        list.forEach(t => {
            html += `<div class="card-base">${actionBtns('transport', t)}
                <div class="marker-font text-[#cfa8a8] text-xs mb-1">ğŸ•’ ${t.time || 'æœªè¨­å®š'}</div>
                <div class="text-sm font-bold">${t.name}</div>
                <div class="text-[11px] text-gray-500 mt-1">${t.note}</div>
            </div>`;
        });
    } else {
        html = `<div class="flex justify-between items-center mb-4"><h2 class="text-lg">å‚™è¨»ç­†è¨˜</h2><button onclick="addItem()" class="btn-rose">+ åŠ ç­†è¨˜</button></div>`;
        store.others.forEach(o => {
            html += `<div class="card-base">${actionBtns('others', o)}
                <div class="text-sm font-bold border-b border-dashed border-[#eaddd0] pb-1 mb-1">ğŸ“Œ ${o.name}</div>
                <div class="text-[11px] text-gray-600 whitespace-pre-wrap">${o.note}</div>
            </div>`;
        });
    }
    area.innerHTML = html;
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('nav-active', b.dataset.id === currentTab));
    localStorage.setItem('ok_trip_v5', JSON.stringify(store));
}

function openModal(tab, id) {
    currentEditId = { tab, id };
    const item = store[tab].find(i => i.id === id);
    const container = document.getElementById('modal-inputs');
    container.innerHTML = '';
    const addField = (label, fieldId, value, type = 'text') => {
        const div = document.createElement('div');
        div.className = 'input-group';
        div.innerHTML = `<label>${label}</label>`;
        let input;
        if(type === 'date-select') {
            input = document.createElement('select');
            ['3/18','3/19','3/20','3/21','3/22'].forEach(d => input.innerHTML += `<option value="${d}" ${value===d?'selected':''}>${d}</option>`);
        } else if(fieldId === 'category') {
            input = document.createElement('select');
            input.innerHTML = `<option value="itinerary">ä¿æŒåœ¨ Trip</option><option value="attractions">â›©ï¸ æ™¯é»</option><option value="restaurants">ğŸœ ç¾é£Ÿ</option><option value="hotels">ğŸ¨ ä½å®¿</option>`;
        } else if(fieldId === 'type') {
            input = document.createElement('select');
            ['é£›æ©Ÿ', 'ç«è»Š', 'æ±½è»Š', 'åœ°éµ'].forEach(t => input.innerHTML += `<option value="${t}" ${value===t?'selected':''}>${t}</option>`);
        } else {
            input = type === 'textarea' ? document.createElement('textarea') : document.createElement('input');
            input.value = value || '';
            if(type === 'textarea') input.rows = 4;
        }
        input.id = `edit-${fieldId}`;
        div.appendChild(input);
        container.appendChild(div);
    };
    if (tab === 'itinerary') {
        addField('æ—¥æœŸ', 'date', item.date, 'date-select');
        addField('æ™‚é–“', 'time', item.time);
        addField('åœ°é»', 'loc', item.loc);
        addField('å‚™è¨»', 'note', item.note, 'textarea');
        addField('è‡ªå‹•åˆ†é¡è‡³...', 'category', 'itinerary');
    } else if (['attractions', 'hotels', 'restaurants'].includes(tab)) {
        addField('æ—¥æœŸ', 'date', item.date, 'date-select');
        addField('åç¨±', 'name', item.name);
        addField('åœ–ç‰‡ç¶²å€', 'img', item.img);
        addField('æ™‚é–“/ç‡Ÿæ¥­', 'time', item.time);
        addField('ç´°ç¯€', 'note', item.note, 'textarea');
    } else if (tab === 'transport') {
        addField('åˆ†é¡', 'type', item.type);
        addField('æ™‚é–“', 'time', item.time);
        addField('äº¤é€šåç¨±', 'name', item.name);
        addField('ç´°ç¯€', 'note', item.note, 'textarea');
    } else {
        addField('æ¨™é¡Œ', 'name', item.name);
        addField('å…§å®¹', 'note', item.note, 'textarea');
    }
    document.getElementById('edit-modal').style.display = 'flex';
}

function saveEdit() {
    const { tab, id } = currentEditId;
    const item = store[tab].find(i => i.id === id);
    if (tab === 'itinerary') {
        item.date = document.getElementById('edit-date').value;
        item.time = document.getElementById('edit-time').value;
        item.loc = document.getElementById('edit-loc').value;
        item.note = document.getElementById('edit-note').value;
        const cat = document.getElementById('edit-category').value;
        if (cat !== 'itinerary') store[cat].push({ id: Date.now(), date: item.date, name: item.loc, img: '', time: item.time, note: item.note });
    } else if (['attractions', 'hotels', 'restaurants'].includes(tab)) {
        item.date = document.getElementById('edit-date').value;
        item.name = document.getElementById('edit-name').value;
        item.img = document.getElementById('edit-img').value;
        item.time = document.getElementById('edit-time').value;
        item.note = document.getElementById('edit-note').value;
    } else if (tab === 'transport') {
        item.type = document.getElementById('edit-type').value;
        item.time = document.getElementById('edit-time').value;
        item.name = document.getElementById('edit-name').value;
        item.note = document.getElementById('edit-note').value;
    } else {
        item.name = document.getElementById('edit-name').value;
        item.note = document.getElementById('edit-note').value;
    }
    closeModal(); render();
}

function switchTab(t) { currentTab = t; render(); }
function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
function addItem() {
    const id = Date.now();
    if (currentTab === 'itinerary') store.itinerary.push({ id, date: selectedDate, time: '12:00', loc: 'æ–°åœ°é»', note: '' });
    else if (['attractions', 'hotels', 'restaurants'].includes(currentTab)) store[currentTab].push({ id, date: selectedDate, name: 'æ–°é …ç›®', img: '', time: '', note: '' });
    else if (currentTab === 'transport') store.transport.push({ id, type: transportType, name: 'æ–°ç´€éŒ„', time: '', note: '' });
    else store.others.push({ id, name: 'æ–°ç­†è¨˜', note: '' });
    render(); openModal(currentTab, id);
}
function deleteItem(tab, id) { if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { store[tab] = store[tab].filter(i => i.id !== id); render(); } }

updateWeather();
render();
</script>
</body>
</html>
